<div id="absensi-container" style="max-width:600px; margin:20px auto; text-align:center; font-family:Arial;">
  <h3>Absensi QR Code</h3>
  <div id="reader" style="width:100%; max-width:400px; margin:0 auto;"></div>
  <p id="scan-status">Status: Siap</p>
</div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
(function(){
  const WEBAPP_URL = "GANTI_DENGAN_URL_WEBAPP"; // dari deploy Apps Script
  const SECRET_TOKEN = "ABSEN2025-KEY-9F7xQ!";  // sama dengan Apps Script

  const scanStatus = document.getElementById("scan-status");
  let lastId = "", lastTime = 0;

  function sendAbsensi(id){
    fetch(WEBAPP_URL, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ token: SECRET_TOKEN, studentId: id })
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.success){
        scanStatus.innerText = "✔ Tercatat: " + id;
      } else {
        scanStatus.innerText = "⚠ " + res.error;
      }
    })
    .catch(err=>{
      scanStatus.innerText = "❌ Error: " + err;
    });
  }

  function onScanSuccess(decodedText) {
    const now = Date.now();
    if(decodedText === lastId && (now - lastTime < 3000)) return; // hindari duplikat cepat
    lastId = decodedText; lastTime = now;
    scanStatus.innerText = "Terdeteksi: " + decodedText;
    sendAbsensi(decodedText.trim());
  }

  Html5Qrcode.getCameras().then(cams=>{
    if(cams && cams.length){
      const camId = cams.find(c=>/back|rear|environment/i.test(c.label))?.id || cams[0].id;
      const qr = new Html5Qrcode("reader");
      qr.start(camId, {fps:10, qrbox:250}, onScanSuccess);
    } else {
      scanStatus.innerText = "Kamera tidak ditemukan";
    }
  }).catch(err=>{
    scanStatus.innerText = "Gagal akses kamera: " + err;
  });
})();
</script>
