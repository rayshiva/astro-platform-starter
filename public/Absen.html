<div id="absensi-container" style="max-width:600px; margin:20px auto; text-align:center; font-family:Arial;">
  <h3>üì∑ Absensi QR Code</h3>
  <div id="reader" style="width:100%; max-width:400px; margin:0 auto; border:1px solid #ccc; border-radius:8px;"></div>
  <p id="scan-status" style="margin-top:10px; font-weight:bold; color:#555;">Status: Menunggu...</p>
  <button id="start-btn" style="padding:8px 16px; margin:5px; border:none; border-radius:6px; background:#2d89ef; color:white; cursor:pointer;">‚ñ∂ Mulai Scan</button>
  <button id="stop-btn" style="padding:8px 16px; margin:5px; border:none; border-radius:6px; background:#e81123; color:white; cursor:pointer;" disabled>‚èπ Stop</button>
</div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzwEWs1wxvbpe7G77fpan7kmr8YXUY16LwOGATdirQSkTz_B0dIuxZ9FCLPuUJqZDKJgg/exec"; 
  const SECRET_TOKEN = "ABSEN2025-KEY-9F7xQ!";

  const scanStatus = document.getElementById("scan-status");
  const startBtn = document.getElementById("start-btn");
  const stopBtn = document.getElementById("stop-btn");
  let lastId = "", lastTime = 0;
  let qrScanner = null;

  function setStatus(text, color="#555") {
    scanStatus.innerText = text;
    scanStatus.style.color = color;
  }

  function sendAbsensi(id){
    fetch(WEBAPP_URL, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ token: SECRET_TOKEN, studentId: id })
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.success){
        setStatus("‚úî Tercatat: " + id, "green");
      } else {
        setStatus("‚ö† " + res.error, "orange");
      }
    })
    .catch(err=>{
      setStatus("‚ùå Error: " + err, "red");
    });
  }

  function onScanSuccess(decodedText) {
    const now = Date.now();
    if(decodedText === lastId && (now - lastTime < 3000)) return; 
    lastId = decodedText; lastTime = now;
    setStatus("Terdeteksi: " + decodedText, "#2d89ef");
    sendAbsensi(decodedText.trim());
  }

  startBtn.onclick = () => {
    Html5Qrcode.getCameras().then(cams=>{
      if(cams && cams.length){
        const camId = cams.find(c=>/back|rear|environment/i.test(c.label))?.id || cams[0].id;
        qrScanner = new Html5Qrcode("reader");
        // Tambah delay kecil biar div siap
        setTimeout(()=>{
          qrScanner.start(camId, {fps:10, qrbox:250}, onScanSuccess)
            .then(()=>{ 
              setStatus("üîç Kamera aktif, silakan scan QR", "#2d89ef");
              startBtn.disabled = true; stopBtn.disabled = false;
            })
            .catch(err=> setStatus("Gagal mulai kamera: " + err, "red"));
        }, 500);
      } else {
        setStatus("Kamera tidak ditemukan", "red");
      }
    }).catch(err=>{
      setStatus("Gagal akses kamera: " + err, "red");
    });
  };

  stopBtn.onclick = () => {
    if(qrScanner){
      qrScanner.stop().then(()=>{
        setStatus("‚èπ Kamera dimatikan", "#555");
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }).catch(err=>{
        setStatus("Gagal stop kamera: " + err, "red");
      });
    }
  };
});
</script>
